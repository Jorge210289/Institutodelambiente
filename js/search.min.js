'use strict';

(function () {
  function getQueryVariable(variable) {
    var query = window.location.search.substring(1);
    var vars = query.split('&');

    for (var i = 0; i < vars.length; i++) {
      var pair = vars[i].split('=');

      if (pair[0] === variable) {
        return decodeURIComponent(pair[1].replace(/\+/g, '%20')).toLowerCase().trim();
      }
    }
  }

  var searchTerm = getQueryVariable('q');
  var wrapper = document.getElementById('search-results');
  var results = [];
  var html = '';

  if (searchTerm) {
    var counter = 0;

    document.getElementById('search').setAttribute('value', searchTerm);

    posts.forEach(function (post) {
      var matches = Object.values(post).some(function (v) {
        return v.toLowerCase().indexOf(searchTerm) >= 0;
      });

      if (matches) {
        results.push({
          post: post,
          bodyIndex: post.content.toLowerCase().indexOf(searchTerm),
          titleIndex: post.title.toLowerCase().indexOf(searchTerm)
        });

        counter++;
      }
    });

    if (results.length > 0) {
      results.forEach(function (result) {
        html += '\n          <article class="border-grey-light border">\n            <h3 class="text-black uppercase mb-3 font-medium hover:text-green px-6 mt-6">\n              <a href="' + result.post.url + '">\n                ' + (result.titleIndex === -1 ? '\n                  ' + result.post.title + '\n                ' : '\n                  ' + result.post.title.substring(0, result.titleIndex) + '<mark>' + result.post.title.substring(result.titleIndex, result.titleIndex + searchTerm.length) + '</mark>' + result.post.title.substring(result.titleIndex + searchTerm.length) + '</a>\n                ') + '\n              </a>\n            </h3>\n            \n            <p class="px-6">\n              ' + (result.bodyIndex === -1 ? '\n                ' + result.post.content + '\n              ' : '\n                ' + result.post.content.substring(0, result.bodyIndex) + '<mark>' + result.post.content.substring(result.bodyIndex, result.bodyIndex + searchTerm.length) + '</mark>' + result.post.content.substring(result.bodyIndex + searchTerm.length) + '</a>\n              ') + '\n            </p>\n            <footer class="border-t border-grey-light border-solid py-4 px-6 mt-6 text-right text-grey font-light text-sm">\n              <span>' + result.post.date + '</span>\n            </footer>\n          </article>\n        ';
      });

      wrapper.innerHTML = html;
    }
  }

  document.querySelector('[data-search-number]').textContent = counter;
})();